<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teaching Hours Calculator</title>
  <style>
    /* your existing styles unchanged */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(45deg, #6a11cb, #2575fc);
      color: white; display: flex; flex-direction: column;
      align-items: center; min-height: 100vh; padding: 20px;
    }
    .container {
      background: rgba(0, 0, 0, 0.85); padding: 30px; border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3); width: 100%; max-width: 900px;
      text-align: center;
    }
    h1 { font-size: 2.4rem; margin-bottom: 15px; font-weight: bold; color: #FFD700; }
    h2 { font-size: 1.6rem; margin-bottom: 15px; color: #f0f0f0; }
    .tabs { display: flex; justify-content: center; margin-bottom: 20px;
      border-bottom: 2px solid #fff; gap: 10px; flex-wrap: wrap; }
    .tab {
      background-color: #6a11cb; color: #fff; padding: 12px 24px; cursor: pointer;
      border-radius: 8px 8px 0 0; font-size: 1.1rem; transition: background-color 0.3s;
    }
    .tab:hover, .tab.active { background-color: #2575fc; }
    .tab-content { display: none; margin-top: 20px; }
    .tab-content.active { display: block; }
    input, select, button {
      width: 80%; padding: 12px; margin: 10px 0; font-size: 1rem;
      border-radius: 8px; border: none; background-color: #f0f0f0; color: #333;
    }
    button {
      background-color: #2575fc; color: white; font-size: 1.1rem;
      cursor: pointer; transition: all 0.3s ease;
    }
    button:hover { background-color: #6a11cb; transform: scale(1.05); }
    .result {
      margin-top: 20px; font-size: 1.2rem; background: rgba(0,0,0,0.5);
      padding: 12px; border-radius: 12px; color: #FFD700;
    }
    .entry-list { margin-top: 20px; max-height: 300px; overflow-y: auto; text-align: left; }
    .entry-item {
      background: rgba(0,0,0,0.4); padding: 12px; margin-bottom: 10px;
      border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
    }
    .entry-item button {
      background-color: #e74c3c; padding: 6px 10px; font-size: 0.9rem;
      border-radius: 6px; border: none;
    }
    .entry-item button:hover { background-color: #c0392b; }
    .footer { font-size: 1rem; margin-top: 30px; color: #f0f0f0; text-align: center; }
    .footer span { font-weight: bold; color: #FFD700; }
    @media (max-width: 768px) {
      .tab { flex: 1; text-align: center; }
      input, select, button { width: 95%; }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Teaching Hours Calculator</h1>

    <div class="tabs">
      <div class="tab active" data-tab="today">Calculate Hours</div>
      <div class="tab" data-tab="monthly">Monthly Tracker</div>
    </div>

    <!-- Calculate Hours -->
    <div id="today" class="tab-content active">
      <h2>Calculate Total Hours</h2>
      <form id="todayForm">
        <div>
          <label for="date">Select Date:</label><br>
          <input type="date" id="date" required>
        </div>
        <div>
          <label for="fromTime">From Time:</label><br>
          <input type="time" id="fromTime" required>
        </div>
        <div>
          <label for="toTime">To Time:</label><br>
          <input type="time" id="toTime" required>
        </div>
        <div>
          <label for="breakTime">Break Time (minutes):</label><br>
          <input type="number" id="breakTime" min="0" required>
        </div>
        <button type="button" onclick="calculateTotalHours()">Calculate</button>
      </form>

      <div id="result" class="result">
        <p>Total Teaching Hours: <span id="totalHours">0</span></p>
        <p>Date: <span id="selectedDate"></span></p>
        <button type="button" onclick="addToMonthlyRecord()">Add to Monthly Record</button>
      </div>
    </div>

    <!-- Monthly Tracker -->
    <div id="monthly" class="tab-content">
      <h2>Monthly Tracker</h2>
      <label for="monthSelect">Select Month:</label>
      <select id="monthSelect"></select>
      <div id="monthlyResult">
        <p>Total Teaching Hours for <span id="monthName"></span>: <span id="monthlyTotal">0</span></p>
      </div>
      <div class="entry-list" id="monthlyEntryList"></div>
    </div>
  </div>

  <!-- Auth Buttons -->
  <div style="margin-top:20px; text-align:center;">
    <button id="signup-btn" onclick="signup()">Sign Up</button>
    <button id="login-btn" onclick="login()">Login</button>
    <button id="logout-btn" onclick="logout()" style="display:none;">Logout</button>
    <p id="user-info" style="margin-top:10px; font-weight:bold;"></p>
  </div>

  <div class="footer">
    <p>Created by <span>Fadil Rafeek CMA</span></p>
  </div>

  <!-- Firebase & App Script -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc, 
    addDoc, 
    collection, 
    getDocs 
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCvfzVvhv3lDC4rzJvgbMXJK-trh65Eg1M",
    authDomain: "teaching-hours-ae6a1.firebaseapp.com",
    projectId: "teaching-hours-ae6a1",
    storageBucket: "teaching-hours-ae6a1.appspot.com",
    messagingSenderId: "239533580131",
    appId: "1:239533580131:web:19841566c3d777a7eafd56",
    measurementId: "G-RWJE4GHJ4Y"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM elements
  const signupBtn = document.getElementById("signup-btn");
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const userInfo = document.getElementById("user-info");

  // SIGNUP
  window.signup = async function() {
    const email = prompt("Enter your email:");
    const password = prompt("Enter a password:");
    try {
      const userCred = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", userCred.user.uid), {
        email: email,
        status: "pending",
        createdAt: new Date()
      });
      alert("Signup successful! Please wait for admin approval.");
      await signOut(auth); // logout until approved
    } catch (err) {
      alert("Signup failed: " + err.message);
    }
  };

  // LOGIN
  window.login = async function() {
    const email = prompt("Enter your email:");
    const password = prompt("Enter your password:");
    try {
      const userCred = await signInWithEmailAndPassword(auth, email, password);
      const uid = userCred.user.uid;
      const userDoc = await getDoc(doc(db, "users", uid));

      if (!userDoc.exists()) {
        alert("⚠️ Your account record is missing. Contact admin.");
        await signOut(auth);
        return;
      }

      if (userDoc.data().status !== "approved") {
        alert("⚠️ Your account is not approved yet.");
        await signOut(auth);
      } else {
        alert("✅ Welcome " + email);
      }
    } catch (err) {
      alert("Login failed: " + err.message);
    }
  };

  // LOGOUT
  window.logout = async function() {
    await signOut(auth);
    alert("Logged out.");
    document.getElementById('monthlyEntryList').innerHTML = '';
    document.getElementById('monthlyTotal').textContent = '0';
  };

  // AUTH STATE LISTENER
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists() || userDoc.data().status !== "approved") {
        await signOut(auth);
        return;
      }
      // ✅ Show logout + user email
      signupBtn.style.display = "none";
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      userInfo.innerText = `Logged in as: ${user.email}`;
    } else {
      // ✅ Show signup/login only
      signupBtn.style.display = "inline-block";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      userInfo.innerText = "";
    }
  });

  // Tabs switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function () {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
    });
  });

  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const monthSelect = document.getElementById('monthSelect');
  months.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m; opt.textContent = m; monthSelect.appendChild(opt);
  });

  let todayData = {};
  function calculateTotalHours() {
    const date = document.getElementById('date').value;
    const fromTime = document.getElementById('fromTime').value;
    const toTime = document.getElementById('toTime').value;
    const breakTime = parseInt(document.getElementById('breakTime').value);
    if (!date || !fromTime || !toTime) { alert("Please fill in all fields."); return; }
    const from = new Date(`1970-01-01T${fromTime}:00`);
    const to = new Date(`1970-01-01T${toTime}:00`);
    let totalMinutes = (to - from) / 60000 - breakTime;
    if (totalMinutes < 0) { alert("Invalid time range."); return; }
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    document.getElementById('totalHours').textContent = `${hours} hours ${minutes} minutes`;
    document.getElementById('selectedDate').textContent = date;
    todayData = { date, minutes: totalMinutes };
  }
  window.calculateTotalHours = calculateTotalHours;

  async function addToMonthlyRecord() {
    const user = auth.currentUser;
    if (!user) { alert("Please login first."); return; }
    if (!todayData.date) { alert("Please calculate today's hours first."); return; }

    const dateObj = new Date(todayData.date);
    const month = months[dateObj.getMonth()];

    await addDoc(collection(db, "users", user.uid, "entries"), {
      day: dateObj.getDate(),
      month: month,
      minutes: todayData.minutes,
      date: todayData.date
    });
    alert("Saved to your account!");

    loadMonthlyData(month);
    monthSelect.value = month;
  }
  window.addToMonthlyRecord = addToMonthlyRecord;

  async function loadMonthlyData(month) {
    const user = auth.currentUser;
    if (!user) return;
    const querySnap = await getDocs(collection(db, "users", user.uid, "entries"));
    const entries = [];
    querySnap.forEach(docSnap => entries.push(docSnap.data()));
    const filtered = entries.filter(e => e.month === month);

    const entryList = document.getElementById('monthlyEntryList');
    entryList.innerHTML = '';
    let totalMinutes = 0;
    filtered.sort((a,b) => a.day - b.day).forEach(entry => {
      totalMinutes += entry.minutes;
      const hours = Math.floor(entry.minutes / 60);
      const minutes = entry.minutes % 60;
      const div = document.createElement('div');
      div.classList.add('entry-item');
      div.innerHTML = `<span>Day ${entry.day}: ${hours}h ${minutes}m</span>`;
      entryList.appendChild(div);
    });
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    document.getElementById('monthlyTotal').textContent = `${hours} hours ${minutes} minutes`;
    document.getElementById('monthName').textContent = month;
  }

  monthSelect.addEventListener('change', function() {
    loadMonthlyData(this.value);
  });

  // init with current month
  const currentMonth = months[new Date().getMonth()];
  monthSelect.value = currentMonth;
  </script>
</body>
</html>
